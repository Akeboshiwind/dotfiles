#!/usr/bin/env python3
"""Export Things 3 to-dos in a single-line format."""

import subprocess
import sys

try:
    import things
except ImportError:
    print("Installing things.py...", file=sys.stderr)
    subprocess.check_call([
        sys.executable, "-m", "pip", "install", "-q",
        "--break-system-packages", "things.py"
    ])
    import things


def build_lookups():
    """Build lookup tables for resolving parent relationships."""
    heading_to_project = {}
    project_to_area = {}

    for project in things.projects():
        project_uuid = project['uuid']
        project_to_area[project_uuid] = project.get('area_title', '')

        # Get full project with items to map headings
        full_project = things.get(project_uuid)
        if full_project and 'items' in full_project:
            for item in full_project['items']:
                if item.get('heading'):
                    heading_to_project[item['heading']] = project_uuid

    return heading_to_project, project_to_area


def resolve_area(todo, heading_to_project, project_to_area):
    """Resolve area by traversing parent hierarchy."""
    # Direct area
    if todo.get('area_title'):
        return todo['area_title']

    # Via project
    if todo.get('project'):
        return project_to_area.get(todo['project'], '')

    # Via heading -> project -> area
    if todo.get('heading'):
        project_uuid = heading_to_project.get(todo['heading'])
        if project_uuid:
            return project_to_area.get(project_uuid, '')

    return ''


def main():
    heading_to_project, project_to_area = build_lookups()

    for todo in things.todos():
        # Filter: type = todo, status = open (incomplete), start is not someday
        if todo.get("type") != "to-do":
            continue
        if todo.get("status") != "incomplete":
            continue
        if todo.get("start") == "Someday":
            continue

        # Resolve area through parent hierarchy
        area = resolve_area(todo, heading_to_project, project_to_area)

        # Exclude items from Templates area
        if area == "Templates":
            continue

        # Extract fields
        title = todo.get("title") or ""
        notes = (todo.get("notes") or "").replace("\n", "â†µ")
        project = todo.get("project_title") or ""
        heading = todo.get("heading_title") or ""
        start = todo.get("start_date") or todo.get("start") or ""
        deadline = todo.get("deadline") or ""
        recurring = todo.get("recurring") or ""

        # Build output with only non-empty fields
        parts = [title]
        if notes:
            parts.append(f"note:{notes}")
        if area:
            parts.append(f"area:{area}")
        if project:
            parts.append(f"project:{project}")
        if heading:
            parts.append(f"heading:{heading}")
        if start:
            parts.append(f"start:{start}")
        if deadline:
            parts.append(f"deadline:{deadline}")
        if recurring:
            parts.append(f"recurring:{recurring}")

        print(" | ".join(parts))


if __name__ == "__main__":
    main()
