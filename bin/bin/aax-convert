#!/usr/bin/env bash
# aax-convert


# >> Utils

usage() {
    cat << USAGE
Usage: aax-convert [OPTIONS] input-file [output-file]

Options:
    -h, --help                   Display this help and exit
    --version                    Output the version information and exit

Examples:
    aax-convert foo.aax          Output 'output.mp4'
    aax-convert foo.aax foo.mp4  Output 'foo.mp4'

Report bugs to <olivershawmarshall+dotfiles@gmail.com>.
USAGE
}

version() {
    cat << VERSION
aax-convert 1.0

Copyright (C) 2019 Oliver Marshall

Written by Oliver Marshall.
VERSION
}



# >> Cli args

while [ "$1" != "" ]; do
    case $1 in
        -h | --help )        usage
                             exit
                             ;;
        --version )          version
                             exit
                             ;;
        * )                  break
    esac
    shift
done

input_file=$1
output_file=${2:-output.mp4}



# >> Bashbooster

# Initialize Bash Booster
source ~/bin/lib/bashbooster.sh



# >> Validate input

if [ -z "$input_file" ]; then
    bb-log-error "No input file supplied"
    echo
    usage
    exit 1
fi



# >> Extract activation bytes

# See help message on where to get your 'activation bytes'
bb-log-info "Extracting activation byes from passwordstore"
activation_bytes="$(pass show personal/amazon.co.uk | sed -n 's/^activation-bytes:\(.*\)\n*$/\1/p')"



# >> Extract activation bytes

bb-log-info "Decoding the DRM protected file to an unprotected file"
ffmpeg -activation_bytes $activation_bytes -i $input_file -vn -c:a copy $output_file
