# Dotfiles

Babashka-based dotfile manager. Installs packages and symlinks config files via a declarative manifest.

## Manifest & Actions

`manifest.edn` defines what to install:

- `bootstrap` - runs first (e.g., install mise, mas, bbin)
- `plan` - list of paths to `cfg/*/base.edn` files or inline maps

Each plan entry can use these actions:

- `:pkg/brew` - Homebrew packages (supports `:head true`)
- `:pkg/mise` - mise tools (`:version`, `:global`)
- `:pkg/mas` - Mac App Store apps
- `:pkg/bbin` - Babashka binaries
- `:fs/symlink` - symlink files `{"~/.target" "./source"}`
- `:fs/symlink-folder` - symlink all files in a folder
- `:osx/defaults` - macOS defaults settings

## Structure

```
├── manifest.edn        # Main manifest
├── bb.edn              # Babashka config
├── src/                # Installer code
│   ├── main.clj        # Entry point, CLI args
│   ├── manifest.clj    # Loads/parses manifest.edn
│   ├── plan.clj        # Merges actions, expands folders, handles stale symlinks
│   ├── execute.clj     # Runs actions (brew, symlinks, etc.)
│   ├── cache.clj       # Tracks symlinks for cleanup
│   └── utils.clj       # Helpers
└── cfg/                # Dotfile configs
    └── <app>/
        ├── base.edn    # Package/symlink definitions
        └── .config/    # Actual config files to symlink
```

## Code Overview

- **main.clj** - Entry point, CLI args, orchestrates the pipeline
- **manifest.clj** - Loads and parses `manifest.edn`
- **plan.clj** - Merges actions, expands symlink folders, handles stale symlinks
- **execute.clj** - Runs each action type (brew install, symlink, etc.)
- **cache.clj** - Tracks symlinks for cleanup

## Usage

```bash
bb -m main              # Run all actions
bb -m main :pkg/brew    # Only brew packages
bb -m main :fs/symlink  # Only symlinks
```

## Ghostty

Config reference docs: `/Applications/Ghostty.app/Contents/Resources/ghostty/doc/ghostty.5.md`

## Neovim Config

**NEVER write or edit `.lua` files in `cfg/nvim/`.** All `.lua` files are auto-generated by nfnl from Fennel source. Only create and edit `.fnl` files - nfnl will compile them to `.lua` automatically when opened in Neovim.

## Troubleshooting

### Neovim crashes when previewing files (treesitter)

Clear and reinstall treesitter parsers:

```bash
rm -rf ~/.local/share/nvim/site/parser/
nvim -c ':TSUpdate'
```

## Landing the Plane (Session Completion)

**When ending a work session**, you MUST complete ALL steps below. Work is NOT complete until `git push` succeeds.

**MANDATORY WORKFLOW:**

1. **File issues for remaining work** - Create issues for anything that needs follow-up
2. **Run quality gates** (if code changed) - Tests, linters, builds
3. **Update issue status** - Close finished work, update in-progress items
4. **PUSH TO REMOTE** - This is MANDATORY:
   ```bash
   git pull --rebase
   bd sync
   git push
   git status  # MUST show "up to date with origin"
   ```
5. **Clean up** - Clear stashes, prune remote branches
6. **Verify** - All changes committed AND pushed
7. **Hand off** - Provide context for next session

**CRITICAL RULES:**
- Work is NOT complete until `git push` succeeds
- NEVER stop before pushing - that leaves work stranded locally
- NEVER say "ready to push when you are" - YOU must push
- If push fails, resolve and retry until it succeeds
